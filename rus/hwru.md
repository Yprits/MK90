# Аппаратная часть МК-90
**Данная информация получена путем обратного проектирования.**
**! Эта страница в процессе. В первую очередь я стараюсь выложить то, что касается непосредственно программирования. Это значит, что некоторые разделы, посвященные исключительно железу, могут быть недоступны в течение некоторого времени.**

## Принципиальные схемы

### Плата процессора
 - [память микрокода](https://user-images.githubusercontent.com/102995285/163818476-dedc99b9-0347-4137-98cb-c728dbd7a35d.png)
 - [АЛУ, блок управления, ПЗУ](https://user-images.githubusercontent.com/102995285/163818484-73607720-0362-473b-a39e-cba6cc16ac00.png)
 - *список проводов, разъемов*

### Системная плата
 - [устройства ввода-вывода](https://user-images.githubusercontent.com/102995285/163818687-fd45853c-1e28-4927-96f3-86674e689990.png)
 - [ОЗУ](https://user-images.githubusercontent.com/102995285/163818695-b1f70a36-53d3-4c40-8557-43c066dc3244.png)
 - [блок питания, схемы печатных плат, список деталей](https://github.com/Yprits/MK90/files/8506071/mk90_sch.pdf)

## Контроллер клавиатуры и дешифратор адреса КА1835ВГ1
- [разводка контактов](https://user-images.githubusercontent.com/102995285/163818988-54bbd834-dc99-4ce2-acaf-94552ebe50d0.png)
- [даташит](https://github.com/Yprits/MK90/files/8506078/guide10.zip)
- 
Возвращает скан-код клавиатуры (строку и столбец нажатой клавиши) по каналу 2 контроллера последовательной шины КА1835ВГ4. Нажатие клавиши также вызывает запрос прерывания к вектору по адресу $00C8.

## ЖКИ и контроллер памяти КА1835ВГ3
- [разводка контактов](https://user-images.githubusercontent.com/102995285/163819284-3ba98338-aa96-41e0-bd1e-397c54aefe6e.png)
- [даташит](https://github.com/Yprits/MK90/files/8506093/guide12.zip)

Микросхема передает данные из ОЗУ драйверам дисплея [КА1835ИД1](https://github.com/Yprits/MK90/files/8506107/ka1835id1.pdf).
```
$E800   адресный регистр, размер слова (2 байта), только запись
        Определяет начальный адрес памяти дисплея
        
$E802   регистр конфигурации, размер слова (2 байта), только запись
        Инициализируется фиксированным значением $88C6
        
$E804   Младший байт адресного регистра

$E806   Младший байт регистра конфигурации
```

## Контроллер устройств ввода-вывода КА1835ВГ4
- [разводка контактов](https://user-images.githubusercontent.com/102995285/163819999-0278dcab-c24d-49fc-a7e6-5d9a23f19402.png)
- [даташит](https://github.com/Yprits/MK90/files/8506121/guide13.zip)

Контроллер поддерживает 8 последовательных каналов, 4 из которых используются в МК-90. Все устройства, подключенный к шине, имеют общие DATA и SELECT, но используют отдельные сигналы CLK.

   - Каналы 0 и 1 используются модулями памяти СМП.
   - Канал 2 используется Канал 2 используется контроллером клавиатуры КА1835ВГ1.
   - Выход CLK канала 3 управляет пьезоизлучателем.

```
$E810   регистр данных, 1 байт
        Записанные данные последовательно передаются через последовательную шину.
        Чтение возвращает содержимое сдвигового регистра, затем с последовательной
          шины смещается следующий байт.
        
$E812   регистр скорости передачи, размер слова
        Этот регистр определяет частоту сигнала CLK.
        частота = 800kHz / значение_регистра
        Чтение возвращает состояние защелок запроса на прерывание.
        
$E814   регистр управления и состояния, размер в байтах
        ФУНКЦИИ ОТДЕЛЬНЫХ БИТОВ ПРИ ЗАПИСИ:
        биты 2-0 выбирают последовательный канал,
        бит 3 определяет направление передачи: 0=ввод, 1=вывод
        Установка направления передачи на ввод приводит к считыванию байта из
          последовательной шины в сдвиговый регистр.
        сброшенный бит 4 разрешает внешние прерывания (например, сигнал CLK в 
          ведомом режиме) по вектору $00C8, наименьший приоритет
        сброшенный бит 5 разрешает прерывания от регистра данных по вектору $00C4
        сброшенный бит 6 разрешает прерывания от ввода INRT по вектору $00 C0, 
          наивысший приоритет
        бит 7 выбирает режим передачи (т. е. какое устройство управляет линией CLK):
          0=slave, 1=master
        ФУНКЦИИ ОТДЕЛЬНЫХ БИТОВ ПРИ ЧТЕНИИ:
        биты 1-0 сбрасываются
        бит 2 возвращает состояние линии RA
        бит 3 возвращает состояние линии SELECT
        биты 6-4 возвращают значения, записанные в биты разрешения прерывания
        бит 7 устанавливается, когда регистр данных готов к чтению/записи
        
$E816   регистр команд, размер 1 байт
        Запись в этот регистр активирует сигнал SELECT, затем записанный байт 
          последовательно передается через последовательную шину или считывается из 
          последовательной шины в сдвиговый регистр, в зависимости от бита 3 регистра $E814.
        Чтение возвращает содержимое сдвигового регистра и деактивирует сигнал SELECT.
```

## Системный контроллер КА1835ВГ5
- [разводка контактов](https://user-images.githubusercontent.com/102995285/163822330-d442fc6c-63ed-4c11-b091-d60c19b31ccd.png)
- [даташит](https://github.com/Yprits/MK90/files/8506213/guide14.zip)

```
$E81A   регистр конфигурации RG1, размер слова (2 байта)
$E81C   регистр конфигурации RG2, размер слова (2 байта)
```

## Часы реального времени КА512ВИ1
- [разводка контактов (2 варианта корпуса)](https://user-images.githubusercontent.com/102995285/163822573-5c0986ec-f1f3-4249-a71f-25fee8093639.png)
- [даташит](https://github.com/Yprits/MK90/files/8506227/ka512vi1.pdf)
- [интерфейс таймера](https://user-images.githubusercontent.com/102995285/163822691-ca50d210-9ce0-4f76-9c6d-466ab5783b62.png)

Прямой аналог часов реального времени MC146818. В качестве базы времени используется кварцевый генератор с частотой 32768 Гц.

Выход прямоугольной волны SQW управляет входом прерывания EVNT (вектор `$0040`) с частотой по умолчанию 32 Гц.

Выход IRQ запроса на прерывание управляет входом прерывания INRT (вектор `$00C0`).

Линии `AD0-AD7` шины микросхемы соединены с линиями системной шины `AD1-AD8`. Поэтому любые данные, записываемые в микросхему, должны быть сдвинуты влево на один бит, а любые данные, считанные с микросхемы, должны быть сдвинуты на один бит вправо. Также регистры микросхем выбираются по последовательным четным адресам.

Чип занимает диапазон адресов $EA00-$EA7E .

Выводы КА512ВИ1 и МС146818 называются по-разному. Вот таблица эквивалентных имен контактов:
```
КА512ВИ1 | MC146818
--------------------
GN1,GN2	   OSC1,OSC2
AD0-AD7   	AD0-AD7
  OV	        VSS
  SE	        CE
  MAC	       AS
 RD/WR      	R/W
  CD	        DS
  SR	       RESET
 RQINR      	IRQ
  SED	      CKFS
  SYN1     	CKOUT
   FL	       PS
  SYN2	      SQW
   U	        VDD
```
## Разное
- [ГОСТ на шину МПИ (MPI)](https://github.com/Yprits/MK90/files/8506257/gost_26765.51-86.pdf)

